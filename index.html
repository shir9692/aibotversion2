<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>AI Concierge Chat with Analytics</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .container {
      display: flex;
      width: 100%;
      max-width: 1600px;
      margin: 20px auto;
      gap: 15px;
      padding: 0 15px;
    }

    #chat {
      flex: 1;
      min-width: 500px;
      max-width: 700px;
      border: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      overflow: hidden;
    }

    #analytics-panel {
      width: 420px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    #analytics-panel.collapsed {
      width: 50px;
    }

    .analytics-header {
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }

    .analytics-header h3 {
      margin: 0;
      font-size: 16px;
      white-space: nowrap;
    }

    #analytics-panel.collapsed .analytics-header h3 {
      writing-mode: vertical-rl;
      transform: rotate(180deg);
    }

    .toggle-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .analytics-content {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }

    #analytics-panel.collapsed .analytics-content {
      display: none;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 20px;
    }

    .action-btn {
      background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
      border: 1px solid #e0e4ff;
      border-radius: 10px;
      padding: 10px 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      font-weight: 600;
      color: #667eea;
    }

    .action-btn:hover {
      border-color: #667eea;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .action-btn:active {
      transform: scale(0.98);
    }

    .action-icon {
      font-size: 20px;
    }

    .action-text {
      font-size: 9px;
      line-height: 1.2;
    }

    .stat-mini {
      background: #f8f9fa;
      border-left: 3px solid #667eea;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }

    .stat-mini-label {
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .stat-mini-value {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }

    .mini-list {
      margin-top: 15px;
    }

    .mini-list-title {
      font-size: 13px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      padding-bottom: 5px;
      border-bottom: 2px solid #f0f0f0;
    }

    .mini-list-item {
      font-size: 12px;
      padding: 6px 0;
      border-bottom: 1px solid #f5f5f5;
      display: flex;
      justify-content: space-between;
    }

    .mini-list-item:last-child {
      border-bottom: none;
    }

    .schedule-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f5f5f5;
      font-size: 12px;
    }

    .schedule-item:last-child {
      border-bottom: none;
    }

    .schedule-label {
      color: #333;
      font-weight: 500;
    }

    .schedule-time {
      color: #667eea;
      font-weight: 600;
      font-size: 11px;
    }

    .mini-count {
      color: #667eea;
      font-weight: 600;
    }

    .ticket-item {
      background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
      border: 1px solid #e0e4ff;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .ticket-item:hover {
      transform: translateX(3px);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }

    .ticket-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .ticket-type {
      font-weight: 600;
      color: #667eea;
      font-size: 13px;
    }

    .ticket-status {
      background: #fff3cd;
      color: #856404;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .ticket-description {
      color: #666;
      font-size: 11px;
      margin-top: 4px;
      line-height: 1.4;
    }

    .ticket-time {
      color: #999;
      font-size: 10px;
      margin-top: 4px;
      font-style: italic;
    }

    .ticket-id {
      color: #999;
      font-size: 10px;
      margin-top: 2px;
    }

    #history {
      flex: 1;
      padding: 12px;
      overflow: auto;
      background: #fafafa;
    }

    .msg {
      margin: 8px 0;
    }

    .user {
      text-align: right;
      color: #003366;
      font-weight: 500;
    }

    .bot {
      text-align: left;
      color: #004400;
    }

    #controls {
      display: flex;
      padding: 12px;
      border-top: 1px solid #eee;
      align-items: center;
      gap: 8px;
      background: white;
    }

    input[type=text] {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }

    input[type=text]:focus {
      outline: none;
      border-color: #667eea;
    }

    button {
      padding: 10px 16px;
      border-radius: 6px;
      border: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s;
    }

    button:hover {
      transform: scale(1.05);
    }

    .suggestion {
      background: #fff;
      border: 1px solid #ddd;
      padding: 8px;
      margin-top: 6px;
      border-radius: 4px;
    }

    .meta {
      font-size: 0.85em;
      color: #666;
      margin-top: 4px;
    }

    #diagnostics {
      border-top: 1px dashed #eee;
      padding: 10px;
      font-size: 0.9em;
      color: #333;
      background: #fcfcfd;
    }

    #diagToggle {
      margin-left: 8px;
    }

    .label {
      font-weight: 600;
      margin-right: 6px;
      color: #222;
    }

    .small {
      font-size: 0.85em;
      color: #666;
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    #rawJson {
      white-space: pre-wrap;
      background: #0f1724;
      color: #dbeafe;
      padding: 8px;
      border-radius: 4px;
      margin-top: 8px;
      overflow: auto;
      max-height: 220px;
    }

    footer {
      padding: 10px 12px;
      font-size: 0.8em;
      color: #666;
      text-align: center;
      border-top: 1px solid #eee;
      background: #fafafa;
    }

    .refresh-indicator {
      font-size: 10px;
      color: #999;
      margin-top: 10px;
      text-align: center;
    }

    .ticker-container {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px;
      border-radius: 12px 12px 0 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .weather-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      margin-bottom: 10px;
    }

    .weather-info {
      display: flex;
      align-items: center;
      gap: 15px;
      font-size: 14px;
      font-weight: 500;
    }

    .weather-temp {
      font-size: 22px;
      font-weight: bold;
    }

    .weather-location {
      font-size: 12px;
      opacity: 0.9;
    }

    .events-section {
      overflow: hidden;
      position: relative;
    }

    .ticker-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 5px;
      opacity: 0.9;
    }

    .ticker-content {
      display: flex;
      animation: scroll 30s linear infinite;
      white-space: nowrap;
    }

    .ticker-item {
      display: inline-flex;
      align-items: center;
      margin-right: 40px;
      font-size: 13px;
    }

    .ticker-icon {
      margin-right: 6px;
      font-size: 16px;
    }

    @keyframes scroll {
      0% {
        transform: translateX(0);
      }

      100% {
        transform: translateX(-50%);
      }
    }

    .ticker-content:hover {
      animation-play-state: paused;
    }

    .ticker-item {
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .ticker-item:hover {
      transform: scale(1.05);
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      animation: fadeIn 0.3s ease;
    }

    .modal.active {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 12px;
    }

    .modal-title {
      font-size: 22px;
      font-weight: 600;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #999;
      transition: color 0.2s;
    }

    .close-btn:hover {
      color: #333;
    }

    .modal-body {
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .modal-btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .modal-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .modal-btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .modal-btn-secondary:hover {
      background: #e0e0e0;
    }
  </style>
</head>

<body>
  <div class="container">
    <div id="chat">
      <!-- Weather & Events Ticker -->
      <div class="ticker-container">
        <!-- User Profile & Logout Header -->
        <div
          style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.3); margin-bottom: 12px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span id="user-avatar" style="font-size: 20px;">üë§</span>
            <span id="user-info" style="font-size: 12px; opacity: 0.9;">Guest</span>
          </div>
          <button onclick="handleLogout()"
            style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;">Logout</button>
        </div>

        <!-- Static Weather Section -->
        <div class="weather-section">
          <div class="weather-info">
            <span class="weather-temp" id="weather-temp">72¬∞F</span>
            <span id="weather-condition">üå§Ô∏è Sunny</span>
          </div>
          <div class="weather-location" id="weather-location">üìç New York City, NY</div>
        </div>

        <!-- Rolling Events Section -->
        <div class="events-section">
          <div class="ticker-title">üéâ Upcoming Events & Activities</div>
          <div class="ticker-content" id="ticker-content">
            <div class="ticker-item"><span class="ticker-icon">üé≠</span>Broadway Show at 8 PM - Times Square</div>
            <div class="ticker-item"><span class="ticker-icon">üçΩÔ∏è</span>Happy Hour 5-7 PM at Hotel Bar</div>
            <div class="ticker-item"><span class="ticker-icon">üé®</span>MoMA Exhibition: Modern Masters - Open until 9
              PM</div>
            <div class="ticker-item"><span class="ticker-icon">üèÉ</span>Morning Yoga - Hotel Gym 7 AM Tomorrow</div>
            <div class="ticker-item"><span class="ticker-icon">‚öΩ</span>Yankees Game Tonight - Yankee Stadium 7:30 PM
            </div>
            <!-- Duplicate for seamless loop -->
            <div class="ticker-item"><span class="ticker-icon">üé≠</span>Broadway Show at 8 PM - Times Square</div>
            <div class="ticker-item"><span class="ticker-icon">üçΩÔ∏è</span>Happy Hour 5-7 PM at Hotel Bar</div>
            <div class="ticker-item"><span class="ticker-icon">üé®</span>MoMA Exhibition: Modern Masters - Open until 9
              PM</div>
            <div class="ticker-item"><span class="ticker-icon">üèÉ</span>Morning Yoga - Hotel Gym 7 AM Tomorrow</div>
            <div class="ticker-item"><span class="ticker-icon">‚öΩ</span>Yankees Game Tonight - Yankee Stadium 7:30 PM
            </div>
          </div>
        </div>
      </div>

      <div id="history"></div>

      <div id="controls">
        <input id="message" placeholder="Ask me anything..." />
        <div style="display: flex; gap: 10px; align-items: center;">
          <label class="small"><input type="checkbox" id="shareLocation" /> üìç Location</label>
          <select id="languageSelect"
            style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; background: white;">
            <option value="auto">üåê Auto-detect</option>
            <option value="en">üá∫üá∏ English</option>
            <option value="es">üá™üá∏ Espa√±ol</option>
            <option value="fr">üá´üá∑ Fran√ßais</option>
            <option value="de">üá©üá™ Deutsch</option>
            <option value="zh-Hans">üá®üá≥ ‰∏≠Êñá</option>
            <option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
            <option value="ko">üá∞üá∑ ÌïúÍµ≠Ïñ¥</option>
            <option value="ar">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
            <option value="pt">üáßüá∑ Portugu√™s</option>
            <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
            <option value="hi">üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
            <option value="it">üáÆüáπ Italiano</option>
          </select>
        </div>
        <button id="send">Send</button>
        <label id="diagToggle" class="small"><input type="checkbox" id="showDiag" /> üîß</label>
      </div>

      <div id="diagnostics" style="display:none;">
        <div class="row"><span class="label">Client-parsed city:</span><span id="clientCity" class="small">-</span>
        </div>
        <div class="row"><span class="label">Payload coords:</span><span id="payloadCoords" class="small">-</span></div>
        <div class="row"><span class="label">Server intent:</span><span id="srvIntent" class="small">-</span></div>
        <div class="row"><span class="label">Server liveLookup:</span><span id="srvLive" class="small">-</span></div>
        <div class="row"><span class="label">Server reply:</span><span id="srvReply" class="small">-</span></div>
        <div id="rawJson" style="display:none"></div>
      </div>

      <footer>AI Concierge - Real-time Analytics Enabled</footer>
    </div>

    <div id="analytics-panel">
      <div class="analytics-header" onclick="toggleAnalytics()">
        <h3>üìä Guest Services</h3>
        <button class="toggle-btn" id="toggle-icon">‚óÄ</button>
      </div>
      <div class="analytics-content">
        <div class="mini-list">
          <div class="mini-list-title">üè® Hotel Hours & Info</div>
          <div id="hotel-schedule">
            <div class="schedule-item">
              <span class="schedule-label">üç≥ Breakfast</span>
              <span class="schedule-time">6:30 AM - 10:30 AM</span>
            </div>
            <div class="schedule-item">
              <span class="schedule-label">üçΩÔ∏è Restaurant</span>
              <span class="schedule-time">11:00 AM - 11:00 PM</span>
            </div>
            <div class="schedule-item">
              <span class="schedule-label">üèä Pool</span>
              <span class="schedule-time">7:00 AM - 10:00 PM</span>
            </div>
            <div class="schedule-item">
              <span class="schedule-label">üí™ Gym</span>
              <span class="schedule-time">24 Hours</span>
            </div>
            <div class="schedule-item">
              <span class="schedule-label">üõéÔ∏è Front Desk</span>
              <span class="schedule-time">24/7</span>
            </div>
            <div class="schedule-item">
              <span class="schedule-label">üö™ Checkout</span>
              <span class="schedule-time">11:00 AM</span>
            </div>
            <div class="schedule-item">
              <span class="schedule-label">üì∂ WiFi</span>
              <span class="schedule-time">Free - HotelGuest2025</span>
            </div>
          </div>
        </div>



        <div class="quick-actions">
          <button class="action-btn" onclick="quickAction('Housekeeping', 'üßπ')">
            <span class="action-icon">üßπ</span>
            <span class="action-text">Housekeeping</span>
          </button>
          <button class="action-btn" onclick="quickAction('Room Service', 'üçΩÔ∏è')">
            <span class="action-icon">üçΩÔ∏è</span>
            <span class="action-text">Room Service</span>
          </button>
          <button class="action-btn" onclick="quickAction('Restaurant Reservation', 'üç∑')">
            <span class="action-icon">üç∑</span>
            <span class="action-text">Restaurant</span>
          </button>
          <button class="action-btn" onclick="quickAction('Transportation', 'üöï')">
            <span class="action-icon">üöï</span>
            <span class="action-text">Taxi</span>
          </button>
          <button class="action-btn" onclick="quickAction('Maintenance', 'üîß')">
            <span class="action-icon">üîß</span>
            <span class="action-text">Maintenance</span>
          </button>
          <button class="action-btn" onclick="quickAction('Concierge', 'üõéÔ∏è')">
            <span class="action-icon">üõéÔ∏è</span>
            <span class="action-text">Concierge</span>
          </button>
        </div>

        <div class="mini-list">
          <div class="mini-list-title">üéØ Your Open Requests</div>
          <div id="recent-tickets-mini">
            <div style="text-align:center; color:#999; padding:10px;">No tickets</div>
          </div>
        </div>

        <div class="refresh-indicator">
          Updates every 5s ‚Ä¢ <span id="last-refresh">-</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Event Modal -->
  <div id="event-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">
          <span id="event-icon"></span>
          <span id="event-title"></span>
        </div>
        <button class="close-btn" onclick="closeEventModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p id="event-description"></p>
        <div id="event-details"
          style="background: #f5f5f5; padding: 12px; border-radius: 6px; margin-top: 12px; font-size: 13px;"></div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-secondary" onclick="closeEventModal()">Close</button>
        <button class="modal-btn modal-btn-primary" onclick="addEventToChat()">Ask Concierge</button>
      </div>
    </div>
  </div>

  <script>
    const historyEl = document.getElementById('history');
    const inputEl = document.getElementById('message');
    const sendBtn = document.getElementById('send');
    const shareCheckbox = document.getElementById('shareLocation');
    const showDiag = document.getElementById('showDiag');
    const diagPanel = document.getElementById('diagnostics');
    const clientCityEl = document.getElementById('clientCity');
    const payloadCoordsEl = document.getElementById('payloadCoords');
    const srvIntentEl = document.getElementById('srvIntent');
    const srvLiveEl = document.getElementById('srvLive');
    const srvReplyEl = document.getElementById('srvReply');
    const rawJsonEl = document.getElementById('rawJson');

    let cachedCoords = null;
    let cachedLocation = null;
    const sessionId = 'session-' + Math.random().toString(36).slice(2, 9);
    const conversationHistory = [];
    let sessionToken = null;
    let userPersona = null;
    let userInfo = null;
    let currentEventData = null;
    let lastSelectedPlace = null;  // Track the last clicked place suggestion

    // Event Modal Functions
    function openEventModal(eventData) {
      currentEventData = eventData;
      document.getElementById('event-icon').textContent = eventData.icon;
      document.getElementById('event-title').textContent = eventData.title;
      document.getElementById('event-description').textContent = eventData.description;

      let detailsHtml = '';
      if (eventData.details) {
        detailsHtml = eventData.details.map(detail => `<div style="margin: 6px 0;"><strong>${detail.label}:</strong> ${detail.value}</div>`).join('');
      }
      document.getElementById('event-details').innerHTML = detailsHtml || '<em>No additional details available</em>';

      document.getElementById('event-modal').classList.add('active');
    }

    function closeEventModal() {
      document.getElementById('event-modal').classList.remove('active');
      currentEventData = null;
    }

    function addEventToChat() {
      if (!currentEventData) return;

      const message = `I'm interested in: ${currentEventData.title}. Can you help me with more information or bookings?`;
      sendMessage(message);
      closeEventModal();
    }

    function handleEventClick(eventData) {
      openEventModal(eventData);
    }

    // Close modal when clicking outside
    document.addEventListener('click', (e) => {
      const modal = document.getElementById('event-modal');
      if (e.target === modal) {
        closeEventModal();
      }
    });

    // Initialize session on page load
    async function initializeSession() {
      // Check if user is logged in
      sessionToken = localStorage.getItem('sessionToken');
      userPersona = localStorage.getItem('userPersona');
      userInfo = localStorage.getItem('userInfo');

      if (!sessionToken) {
        // Not logged in, redirect to login page
        window.location.href = 'login.html';
        return;
      }

      try {
        // Verify session with server
        const response = await fetch('http://localhost:3000/api/verify-session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            sessionToken: sessionToken
          })
        });

        if (!response.ok) {
          // Session is invalid
          localStorage.clear();
          window.location.href = 'login.html';
          return;
        }

        // Session is valid, update UI
        updateUserInfo();
      } catch (error) {
        console.error('Session verification failed:', error);
        localStorage.clear();
        window.location.href = 'login.html';
      }
    }

    function updateUserInfo() {
      try {
        const info = JSON.parse(userInfo || '{}');
        const avatar = document.getElementById('user-avatar');
        const userDisplay = document.getElementById('user-info');

        if (userPersona === 'guest') {
          avatar.textContent = 'üë§';
          userDisplay.textContent = `${info.guestName || 'Guest'} | Room ${info.roomNumber || '?'}`;
        } else if (userPersona === 'staff') {
          avatar.textContent = 'üë®‚Äçüíº';
          userDisplay.textContent = `${info.staffName || 'Staff'} (Employee)`;
        }
      } catch (error) {
        console.error('Error updating user info:', error);
      }
    }

    async function handleLogout() {
      try {
        await fetch('http://localhost:3000/api/logout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            sessionToken: sessionToken
          })
        });
      } catch (error) {
        console.error('Logout error:', error);
      }

      // Clear local storage
      localStorage.clear();

      // Redirect to login page
      window.location.href = 'login.html';
    }

    function append(text, who = 'bot', messageId = null) {
      const d = document.createElement('div');
      d.className = 'msg ' + (who === 'user' ? 'user' : 'bot');

      // Create text span
      const textSpan = document.createElement('span');
      textSpan.innerText = (who === 'user' ? 'You: ' : 'Bot: ') + text;
      d.appendChild(textSpan);

      // Add rating buttons for bot messages
      if (who === 'bot' && messageId) {
        const ratingDiv = document.createElement('div');
        ratingDiv.className = 'rating-buttons';
        ratingDiv.style.display = 'inline-flex';

        const thumbsUp = document.createElement('button');
        thumbsUp.className = 'rating-btn thumbs-up';
        thumbsUp.innerHTML = 'üëç';
        thumbsUp.title = 'Helpful response';
        thumbsUp.onclick = () => rateResponse(messageId, 'positive', thumbsUp, thumbsDown);

        const thumbsDown = document.createElement('button');
        thumbsDown.className = 'rating-btn thumbs-down';
        thumbsDown.innerHTML = 'üëé';
        thumbsDown.title = 'Not helpful';
        thumbsDown.onclick = () => rateResponse(messageId, 'negative', thumbsUp, thumbsDown);

        ratingDiv.appendChild(thumbsUp);
        ratingDiv.appendChild(thumbsDown);
        d.appendChild(ratingDiv);
      }

      historyEl.appendChild(d);
      historyEl.scrollTop = historyEl.scrollHeight;
      return d;
    }

    function appendSuggestion(s) {
      const el = document.createElement('div');
      el.className = 'suggestion';
      el.style.cursor = 'pointer';
      el.innerHTML = `<strong>${escapeHtml(s.name)}</strong> <span class="small">(${escapeHtml(s.type)})</span>`;
      if (s.reason) {
        const r = document.createElement('div');
        r.className = 'meta';
        r.innerText = `Reason: ${s.reason}`;
        el.appendChild(r);
      }

      // Add click handler to select place and ask for more details
      el.onclick = () => {
        lastSelectedPlace = s;  // Store the selected place
        const detailsRequest = `Tell me more about ${escapeHtml(s.name)}`;
        append(detailsRequest, 'user', null);
        sendMessage(detailsRequest);
      };

      // Add hover effect
      el.onmouseenter = () => {
        el.style.backgroundColor = '#f0f0f0';
        el.style.fontWeight = 'bold';
      };
      el.onmouseleave = () => {
        el.style.backgroundColor = '';
        el.style.fontWeight = 'normal';
      };

      historyEl.appendChild(el);
      historyEl.scrollTop = historyEl.scrollHeight;
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
    }

    async function rateResponse(messageId, rating, thumbsUpBtn, thumbsDownBtn) {
      try {
        const response = await fetch('http://localhost:3000/api/rate-response', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + sessionToken
          },
          body: JSON.stringify({
            sessionId,
            messageId,
            rating,
            timestamp: new Date().toISOString()
          })
        });

        if (response.ok) {
          // Visual feedback
          if (rating === 'positive') {
            thumbsUpBtn.classList.add('selected');
            thumbsDownBtn.style.display = 'none';
          } else {
            thumbsDownBtn.classList.add('selected');
            thumbsUpBtn.style.display = 'none';
          }
          console.log('Rating submitted:', rating);
        }
      } catch (error) {
        console.error('Failed to submit rating:', error);
      }
    }

    function parseCityFromText(text) {
      const m = text.match(/near\s+([a-zA-Z\s,]+)/i);
      if (!m) return null;
      const candidate = m[1].trim();
      const token = candidate.toLowerCase();
      if (token === 'me' || token === 'here' || token === 'my hotel' || token === 'myhotel') return null;
      return candidate;
    }

    async function getBrowserLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject(new Error('Geolocation not supported'));
        navigator.geolocation.getCurrentPosition(pos => {
          resolve({ lat: pos.coords.latitude.toString(), lon: pos.coords.longitude.toString() });
        }, err => reject(err), { maximumAge: 60000, timeout: 10000 });
      });
    }

    showDiag.addEventListener('change', () => {
      diagPanel.style.display = showDiag.checked ? 'block' : 'none';
      rawJsonEl.style.display = showDiag.checked ? 'block' : 'none';
    });

    async function sendMessage(text) {
      append(text, 'user', null);
      const botPlaceholder = append('...', 'bot', null);

      const clientCity = parseCityFromText(text);
      clientCityEl.innerText = clientCity || '""';

      let consentLocation = false;
      let coords = null;
      payloadCoordsEl.innerText = '""';
      if (shareCheckbox.checked) {
        consentLocation = true;
        try {
          if (!cachedCoords) cachedCoords = await getBrowserLocation();
          coords = cachedCoords;
          payloadCoordsEl.innerText = `${coords.lat}, ${coords.lon}`;
        } catch (err) {
          shareCheckbox.checked = false;
          consentLocation = false;
          payloadCoordsEl.innerText = 'permission denied / unavailable';
          botPlaceholder.innerText = 'Bot: Could not get browser location (permission denied or timeout). Sending without location.';
        }
      }

      const payload = { sessionId, message: text, consentLocation, coords, conversationHistory, sessionToken, lastPlace: lastSelectedPlace };

      try {
        const r = await fetch('http://localhost:3000/api/message', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + sessionToken
          },
          body: JSON.stringify(payload)
        });

        if (r.status === 401) {
          // Session expired
          localStorage.clear();
          window.location.href = 'login.html';
          return;
        }

        const json = await r.json();

        srvIntentEl.innerText = json.intent || '""';
        srvLiveEl.innerText = json.liveLookup === undefined ? '""' : String(json.liveLookup);
        srvReplyEl.innerText = json.reply || '""';
        rawJsonEl.innerText = JSON.stringify(json, null, 2);

        // Generate unique message ID for this response
        const messageId = json.messageId || 'msg-' + Date.now() + '-' + Math.random().toString(36).slice(2, 9);

        // Remove placeholder and add new message with rating buttons
        botPlaceholder.remove();
        append(json.reply || 'Sorry, something went wrong.', 'bot', messageId);

        // Track conversation history
        conversationHistory.push({ role: 'user', content: text });
        conversationHistory.push({ role: 'assistant', content: json.reply });
        if (conversationHistory.length > 10) conversationHistory.splice(0, 2);

        if (json.suggestions && json.suggestions.length) {
          const label = document.createElement('div');
          label.className = 'meta';
          label.innerText = json.liveLookup ? 'Live suggestions:' : 'Hotel suggestions (live unavailable):';
          historyEl.appendChild(label);
          json.suggestions.forEach(s => appendSuggestion(s));
        }

        // Refresh analytics after message
        fetchAnalytics();
      } catch (err) {
        botPlaceholder.innerText = 'Bot: Error contacting server';
        rawJsonEl.innerText = String(err && err.message ? err.message : err);
      }
    }

    sendBtn.onclick = () => {
      const t = inputEl.value.trim();
      if (!t) return;
      sendMessage(t);
      inputEl.value = '';
    };

    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendBtn.click();
    });

    // Analytics functions
    function toggleAnalytics() {
      const panel = document.getElementById('analytics-panel');
      const icon = document.getElementById('toggle-icon');
      panel.classList.toggle('collapsed');
      icon.textContent = panel.classList.contains('collapsed') ? '‚ñ∂' : '‚óÄ';
    }

    async function quickAction(requestType, icon) {
      const roomNumber = prompt(`${icon} ${requestType}\n\nPlease enter your room number:`, '209');
      if (!roomNumber) return;

      const details = prompt('Any specific details or requests?', '');

      try {
        const response = await fetch('http://localhost:3000/api/message', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + sessionToken
          },
          body: JSON.stringify({
            sessionId,
            message: `Create a ticket for ${requestType}. Room ${roomNumber}. Details: ${details || 'No specific details'}`,
            consentLocation: false,
            coords: null,
            conversationHistory,
            sessionToken
          })
        });

        const result = await response.json();

        // Show confirmation in chat
        append(`Request submitted: ${requestType} for Room ${roomNumber}`, 'user', null);
        append(result.reply || 'Your request has been submitted. Our team will assist you shortly.', 'bot', null);

        // Refresh analytics to show new ticket
        fetchAnalytics();
      } catch (error) {
        append(`Failed to submit request. Please try again or contact front desk.`, 'bot', null);
      }
    }

    async function fetchAnalytics() {
      try {
        const response = await fetch('http://localhost:3000/api/analytics');
        const data = await response.json();
        updateAnalytics(data);
      } catch (error) {
        console.error('Failed to fetch analytics:', error);
      }
    }

    function updateAnalytics(data) {

      // Show only tickets for the current guest
      const info = JSON.parse(userInfo || '{}');
      const guestRoom = info.roomNumber;
      const guestName = info.guestName;
      const tickets = (data.tickets || []).filter(t => {
        // Match by room number or guest name
        return (t.roomNumber && t.roomNumber == guestRoom) || (t.guestName && t.guestName == guestName);
      });
      const openTickets = tickets.filter(t => t.status !== 'closed' && t.status !== 'resolved');
      const recentTickets = openTickets.slice(-5).reverse();
      const ticketsHtml = recentTickets.length > 0
        ? recentTickets.map(t => `
            <div class="mini-list-item">
              <span><strong>${t.requestType}</strong> (${t.status || 'open'})</span>
              <span class="mini-count">${t.ticketId.split('-')[1].slice(0, 6)}</span>
              <div style="font-size:11px;color:#555;">Room: ${t.roomNumber || '?'} | ${t.guestName || ''}</div>
              <div style="font-size:11px;color:#888;">${t.description || ''}</div>
            </div>
          `).join('')
        : '<div style="text-align:center; color:#999; padding:10px;">No open requests</div>';
      document.getElementById('recent-tickets-mini').innerHTML = ticketsHtml;



      // Update refresh time
      document.getElementById('last-refresh').textContent = new Date().toLocaleTimeString();
    }

    // Initial greeting (no rating needed for greeting)
    append('Hello! Welcome to AI Concierge. How can I help you today?', 'bot', null);

    // Initialize session and then fetch analytics
    document.addEventListener('DOMContentLoaded', () => {
      initializeSession();
      fetchAnalytics();
      setInterval(fetchAnalytics, 5000);
    });

    // Update weather and events ticker
    async function updateTicker() {
      try {
        // Get current time for dynamic events
        const now = new Date();
        const hour = now.getHours();
        const dayOfWeek = now.toLocaleDateString('en-US', { weekday: 'long' });

        // Try to get user's location
        let userLocation = cachedLocation || 'New York City, NY';
        let coords = cachedCoords;

        // Attempt to get browser location if not cached
        if (!cachedCoords) {
          try {
            const position = await new Promise((resolve, reject) => {
              navigator.geolocation.getCurrentPosition(resolve, reject, {
                timeout: 5000,
                maximumAge: 300000
              });
            });
            cachedCoords = {
              lat: position.coords.latitude.toString(),
              lon: position.coords.longitude.toString()
            };
            coords = cachedCoords;

            // Reverse geocode to get city name
            const geoResponse = await fetch(
              `https://nominatim.openstreetmap.org/reverse?lat=${coords.lat}&lon=${coords.lon}&format=json`
            );
            const geoData = await geoResponse.json();

            if (geoData.address) {
              const city = geoData.address.city || geoData.address.town || geoData.address.village || geoData.address.county;
              const state = geoData.address.state;
              const country = geoData.address.country;
              cachedLocation = city && state ? `${city}, ${state}` : (city || country || 'Your Location');
              userLocation = cachedLocation;
            }
          } catch (error) {
            console.log('Location not available, using default NYC');
          }
        } else {
          userLocation = cachedLocation;
        }

        // Fetch real weather data using Open-Meteo API (free, no key needed)
        let weatherData = { temp: 72, condition: 'üå§Ô∏è Sunny', icon: '‚òÄÔ∏è' };
        if (coords) {
          try {
            const weatherResponse = await fetch(
              `https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current_weather=true&temperature_unit=fahrenheit`
            );
            const weather = await weatherResponse.json();

            if (weather.current_weather) {
              const temp = Math.round(weather.current_weather.temperature);
              const weatherCode = weather.current_weather.weathercode;

              // Map weather codes to conditions
              const weatherConditions = {
                0: { condition: '‚òÄÔ∏è Clear', icon: '‚òÄÔ∏è' },
                1: { condition: 'üå§Ô∏è Mostly Clear', icon: 'üå§Ô∏è' },
                2: { condition: '‚õÖ Partly Cloudy', icon: '‚õÖ' },
                3: { condition: '‚òÅÔ∏è Cloudy', icon: '‚òÅÔ∏è' },
                45: { condition: 'üå´Ô∏è Foggy', icon: 'üå´Ô∏è' },
                48: { condition: 'üå´Ô∏è Foggy', icon: 'üå´Ô∏è' },
                51: { condition: 'üå¶Ô∏è Light Rain', icon: 'üå¶Ô∏è' },
                61: { condition: 'üåßÔ∏è Rain', icon: 'üåßÔ∏è' },
                71: { condition: 'üå®Ô∏è Snow', icon: 'üå®Ô∏è' },
                95: { condition: '‚õàÔ∏è Thunderstorm', icon: '‚õàÔ∏è' }
              };

              const weatherInfo = weatherConditions[weatherCode] || { condition: 'üå§Ô∏è Partly Cloudy', icon: '‚õÖ' };
              weatherData = { temp, condition: weatherInfo.condition, icon: weatherInfo.icon };
            }
          } catch (error) {
            console.log('Weather API failed, using default');
          }
        }

        // Update static weather display with real data
        document.getElementById('weather-temp').textContent = `${weatherData.temp}¬∞F`;
        document.getElementById('weather-condition').textContent = weatherData.condition;
        document.getElementById('weather-location').textContent = `üìç ${userLocation}`;

        // Generate location-specific events
        const isNYC = userLocation.includes('New York');
        const events = [];

        if (isNYC) {
          // NYC-specific events
          events.push(
            {
              icon: 'üé≠',
              title: 'Broadway Show: Hamilton',
              text: 'Broadway Show: Hamilton - Richard Rodgers Theatre 8 PM',
              description: 'Experience the critically acclaimed musical Hamilton at the Richard Rodgers Theatre.',
              details: [
                { label: 'Location', value: 'Richard Rodgers Theatre, Times Square' },
                { label: 'Time', value: '8:00 PM' },
                { label: 'Duration', value: '2 hours 45 minutes' },
                { label: 'Price Range', value: '$$ - $$$' }
              ]
            },
            {
              icon: 'üóΩ',
              title: 'Statue of Liberty Tours',
              text: 'Statue of Liberty Tours - Departing every hour from Battery Park',
              description: 'Visit one of America\'s most iconic monuments with guided tours.',
              details: [
                { label: 'Location', value: 'Battery Park, Downtown Manhattan' },
                { label: 'Departures', value: 'Every hour, 9 AM - 5 PM' },
                { label: 'Duration', value: '3-4 hours' },
                { label: 'Price', value: '$24.50 per adult' }
              ]
            },
            {
              icon: 'üé®',
              title: 'MoMA Exhibition: Modern Masters',
              text: 'MoMA Exhibition: Modern Masters - Open until 9 PM',
              description: 'Explore world-class modern and contemporary art at the Museum of Modern Art.',
              details: [
                { label: 'Location', value: 'Museum of Modern Art, Midtown' },
                { label: 'Hours', value: '10:30 AM - 9:00 PM' },
                { label: 'Admission', value: '$25 general admission' },
                { label: 'Highlights', value: 'Picasso, Warhol, Van Gogh' }
              ]
            },
            {
              icon: '‚öΩ',
              title: 'Yankees Game Tonight',
              text: 'Yankees Game Tonight - Yankee Stadium 7:30 PM',
              description: 'Catch the New York Yankees in action at historic Yankee Stadium.',
              details: [
                { label: 'Location', value: 'Yankee Stadium, Bronx' },
                { label: 'Time', value: '7:30 PM' },
                { label: 'Opponent', value: 'Boston Red Sox' },
                { label: 'Tickets', value: 'Available at box office' }
              ]
            },
            {
              icon: 'üéµ',
              title: `${dayOfWeek} Live Jazz`,
              text: `${dayOfWeek} Live Jazz - Blue Note Jazz Club 9 PM`,
              description: 'Enjoy world-class live jazz performances at the legendary Blue Note.',
              details: [
                { label: 'Location', value: 'Blue Note Jazz Club, Greenwich Village' },
                { label: 'Time', value: '9:00 PM' },
                { label: 'Cover Charge', value: '$20 - $40' },
                { label: 'Reservations', value: 'Recommended' }
              ]
            },
            {
              icon: 'üçï',
              title: 'Best Pizza Tour',
              text: 'Best Pizza Tour - Little Italy & Brooklyn',
              description: 'Taste authentic New York pizza at the city\'s most famous pizzerias.',
              details: [
                { label: 'Duration', value: '2.5 hours' },
                { label: 'Includes', value: '3-4 pizza slices + toppings' },
                { label: 'Price', value: '$65 per person' },
                { label: 'Neighborhoods', value: 'Little Italy & Brooklyn' }
              ]
            }
          );
        } else {
          // Generic hotel events for any location
          events.push(
            {
              icon: 'üé≠',
              title: 'Local Theater',
              text: 'Check Local Theater Performances Tonight',
              description: 'Discover local theatrical performances and live shows in the area.',
              details: [
                { label: 'Type', value: 'Theater & Live Performances' },
                { label: 'Availability', value: 'Various times' },
                { label: 'Ask Concierge', value: 'For personalized recommendations' }
              ]
            },
            {
              icon: 'üé®',
              title: 'Museums & Art Galleries',
              text: 'Visit Local Museums & Art Galleries',
              description: 'Explore world-class art and cultural institutions nearby.',
              details: [
                { label: 'Type', value: 'Museums & Galleries' },
                { label: 'Variety', value: 'Modern, Classical, Contemporary' },
                { label: 'Ask Concierge', value: 'For recommendations based on your interests' }
              ]
            },
            {
              icon: 'üçΩÔ∏è',
              title: 'Downtown Dining',
              text: 'Explore Downtown Restaurants & Cafes',
              description: 'Discover the finest dining experiences in the area.',
              details: [
                { label: 'Cuisines', value: 'International & Local' },
                { label: 'Price Range', value: '$ - $$$' },
                { label: 'Ask Concierge', value: 'For reservations & recommendations' }
              ]
            },
            {
              icon: 'üèõÔ∏è',
              title: 'Historical Sites',
              text: 'Historical Sites & City Tours Available',
              description: 'Learn about the rich history of this city through guided tours.',
              details: [
                { label: 'Types', value: 'Walking Tours, Bus Tours' },
                { label: 'Duration', value: '2-4 hours' },
                { label: 'Ask Concierge', value: 'For booking & information' }
              ]
            },
            {
              icon: 'üéµ',
              title: `${dayOfWeek} Live Music`,
              text: `${dayOfWeek} Live Music - Ask Concierge for Recommendations`,
              description: 'Enjoy live music performances at local venues.',
              details: [
                { label: 'Genres', value: 'Jazz, Rock, Classical, Pop' },
                { label: 'Venues', value: 'Various throughout the city' },
                { label: 'Ask Concierge', value: 'For tonight\'s performances' }
              ]
            },
            {
              icon: 'üö∂',
              title: 'Walking Tours',
              text: 'Walking Tours & Local Attractions',
              description: 'Explore the city on foot with guided neighborhood tours.',
              details: [
                { label: 'Routes', value: 'Multiple themed tours available' },
                { label: 'Duration', value: '2-3 hours' },
                { label: 'Ask Concierge', value: 'For available tours' }
              ]
            }
          );
        }

        // Add time-based hotel events (works anywhere)
        events.push(
          {
            icon: 'üçΩÔ∏è',
            title: hour < 19 ? 'Happy Hour' : 'Late Night Menu',
            text: hour < 19 ? 'Happy Hour 5-7 PM - Hotel Rooftop Bar' : 'Late Night Menu - Hotel Restaurant until 2 AM',
            description: hour < 19 ? 'Enjoy discounted drinks and appetizers at our rooftop bar.' : 'Order from our late-night menu available until 2 AM.',
            details: [
              { label: 'Location', value: hour < 19 ? 'Hotel Rooftop Bar' : 'Hotel Restaurant' },
              { label: 'Hours', value: hour < 19 ? '5:00 PM - 7:00 PM' : '11:00 PM - 2:00 AM' },
              { label: 'Call Extension', value: '2050' }
            ]
          },
          {
            icon: 'üèÉ',
            title: hour < 7 ? 'Morning Yoga' : 'Evening Fitness',
            text: hour < 7 ? 'Morning Yoga Class - Hotel Gym 7 AM' : 'Evening Fitness Class - Hotel Gym 6 PM',
            description: hour < 7 ? 'Start your day with a relaxing yoga session.' : 'Join our evening fitness class to stay active.',
            details: [
              { label: 'Location', value: 'Hotel Gym, Level 2' },
              { label: 'Time', value: hour < 7 ? '7:00 AM' : '6:00 PM' },
              { label: 'Duration', value: '45 minutes' },
              { label: 'No Prior Booking', value: 'Drop-in welcome!' }
            ]
          },
          {
            icon: 'üõéÔ∏è',
            title: 'Concierge Services',
            text: 'Concierge Services Available 24/7',
            description: 'Our concierge team is always available to assist with your needs.',
            details: [
              { label: 'Services', value: 'Reservations, Bookings, Recommendations' },
              { label: 'Available', value: '24 hours, 7 days a week' },
              { label: 'Reach Us', value: 'Dial 0 from your room or visit the lobby' }
            ]
          },
          {
            icon: 'üöï',
            title: 'Express Taxi Service',
            text: 'Express Taxi Service - Ask Front Desk',
            description: 'Need a ride? Our express taxi service is fast and reliable.',
            details: [
              { label: 'Response Time', value: 'Typically 5-10 minutes' },
              { label: 'Available', value: '24 hours' },
              { label: 'Book At', value: 'Front Desk or Call Extension 2000' }
            ]
          }
        );

        // Build rolling events HTML with click handlers (duplicate for seamless loop)
        const eventsHTML = [...events, ...events].map((e, idx) =>
          `<div class="ticker-item" onclick="handleEventClick({icon: '${e.icon}', title: '${e.title.replace(/'/g, "\\'")}', description: '${e.description.replace(/'/g, "\\'")}', details: ${JSON.stringify(e.details).replace(/"/g, '&quot;')}})"><span class="ticker-icon">${e.icon}</span>${e.text}</div>`
        ).join('');

        document.getElementById('ticker-content').innerHTML = eventsHTML;
      } catch (error) {
        console.error('Failed to update ticker:', error);
      }
    }

    // Update ticker on load and every 60 seconds
    updateTicker();
    setInterval(updateTicker, 60000);


// ============================================
// GUEST TICKETS LOADING
// ============================================

// Fetch and display guest's open tickets
async function loadMyTickets() {
    if (!sessionToken) return;

    try {
        const response = await fetch('http://localhost:3000/api/my-tickets', {
            headers: {
                'Authorization': `Bearer ${sessionToken}`
            }
        });

        if (!response.ok) {
            console.error('Failed to fetch tickets');
            return;
        }

        const data = await response.json();
        renderTickets(data.tickets || []);

        // Update last refresh time
        const now = new Date();
        document.getElementById('last-refresh').textContent = now.toLocaleTimeString();
    } catch (error) {
        console.error('Error loading tickets:', error);
    }
}

// Render tickets in the sidebar
function renderTickets(tickets) {
    const container = document.getElementById('recent-tickets-mini');
    let newHtml = '';

    if (!tickets || tickets.length === 0) {
        newHtml = '<div style="text-align:center; color:#999; padding:10px;">No open tickets</div>';
    } else {
        newHtml = tickets.map(ticket => {
            const createdDate = new Date(ticket.createdAt || ticket.timestamp);
            const timeAgo = getTimeAgo(createdDate);
            const type = ticket.type || ticket.requestType || 'Service';
            const description = ticket.description || 'No description';
            const ticketId = ticket.ticketId || ticket._id || 'N/A';
            
            return '<div class="ticket-item"><div class="ticket-header"><div class="ticket-type">' + type + '</div><div class="ticket-status">' + (ticket.status || 'Open') + '</div></div><div class="ticket-description">' + description.substring(0, 60) + (description.length > 60 ? '...' : '') + '</div><div class="ticket-time">‚è±Ô∏è ' + timeAgo + '</div><div class="ticket-id">#' + ticketId + '</div></div>';
        }).join('');
    }

    // Only update if content has changed to prevent blinking
    if (container.innerHTML !== newHtml) {
        container.innerHTML = newHtml;
    }
}

// Helper function to get time ago
function getTimeAgo(date) {
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);

    if (seconds < 60) return seconds + 's ago';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return minutes + 'm ago';
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return hours + 'h ago';
    const days = Math.floor(hours / 24);
    return days + 'd ago';
}

    // Initialize ticket loading for guests
    // Ensure session is initialized first
    if (typeof initializeSession === 'function') {
        initializeSession().then(() => {
            if (sessionToken && userPersona === 'guest') {
                loadMyTickets();
                setInterval(loadMyTickets, 5000);
            }
        });
    } else {
        // Fallback if initializeSession is not available or already ran
        if (sessionToken && userPersona === 'guest') {
            loadMyTickets();
            setInterval(loadMyTickets, 5000);
        }
    }

  </script>
</body>

</html>