<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>AI Concierge Chat with Analytics</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; 
      padding: 0; 
      display:flex; 
      height:100vh; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .container {
      display: flex;
      width: 100%;
      max-width: 1600px;
      margin: 20px auto;
      gap: 15px;
      padding: 0 15px;
    }
    #chat { 
      flex: 1;
      min-width: 500px;
      max-width: 700px;
      border:1px solid #ddd; 
      display:flex; 
      flex-direction:column; 
      background:#fff; 
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
      border-radius: 12px;
      overflow: hidden;
    }
    #analytics-panel {
      width: 420px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    #analytics-panel.collapsed {
      width: 50px;
    }
    .analytics-header {
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }
    .analytics-header h3 {
      margin: 0;
      font-size: 16px;
      white-space: nowrap;
    }
    #analytics-panel.collapsed .analytics-header h3 {
      writing-mode: vertical-rl;
      transform: rotate(180deg);
    }
    .toggle-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .analytics-content {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }
    #analytics-panel.collapsed .analytics-content {
      display: none;
    }
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 20px;
    }
    .action-btn {
      background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
      border: 1px solid #e0e4ff;
      border-radius: 10px;
      padding: 10px 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      font-weight: 600;
      color: #667eea;
    }
    .action-btn:hover {
      border-color: #667eea;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .action-btn:active {
      transform: scale(0.98);
    }
    .action-icon {
      font-size: 20px;
    }
    .action-text {
      font-size: 9px;
      line-height: 1.2;
    }
    .stat-mini {
      background: #f8f9fa;
      border-left: 3px solid #667eea;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }
    .stat-mini-label {
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .stat-mini-value {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }
    .mini-list {
      margin-top: 15px;
    }
    .mini-list-title {
      font-size: 13px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      padding-bottom: 5px;
      border-bottom: 2px solid #f0f0f0;
    }
    .mini-list-item {
      font-size: 12px;
      padding: 6px 0;
      border-bottom: 1px solid #f5f5f5;
      display: flex;
      justify-content: space-between;
    }
    .mini-list-item:last-child {
      border-bottom: none;
    }
    .schedule-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f5f5f5;
      font-size: 12px;
    }
    .schedule-item:last-child {
      border-bottom: none;
    }
    .schedule-label {
      color: #333;
      font-weight: 500;
    }
    .schedule-time {
      color: #667eea;
      font-weight: 600;
      font-size: 11px;
    }
    .mini-count {
      color: #667eea;
      font-weight: 600;
    }
    #history { 
      flex:1; 
      padding:12px; 
      overflow:auto; 
      background:#fafafa; 
    }
    .msg { margin:8px 0; }
    .user { text-align:right; color:#003366; font-weight: 500; }
    .bot { text-align:left; color:#004400; }
    #controls { 
      display:flex; 
      padding:12px; 
      border-top:1px solid #eee; 
      align-items:center; 
      gap:8px; 
      background: white;
    }
    input[type=text]{ 
      flex:1; 
      padding:10px; 
      border:1px solid #ccc; 
      border-radius:6px; 
      font-size: 14px;
    }
    input[type=text]:focus {
      outline: none;
      border-color: #667eea;
    }
    button{ 
      padding:10px 16px; 
      border-radius:6px; 
      border:none; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      cursor:pointer; 
      font-weight: 600;
      transition: transform 0.2s;
    }
    button:hover{ 
      transform: scale(1.05);
    }
    .suggestion{ 
      background:#fff; 
      border:1px solid #ddd; 
      padding:8px; 
      margin-top:6px; 
      border-radius:4px; 
    }
    .meta { font-size: 0.85em; color: #666; margin-top:4px; }
    #diagnostics { 
      border-top:1px dashed #eee; 
      padding:10px; 
      font-size:0.9em; 
      color:#333; 
      background:#fcfcfd; 
    }
    #diagToggle { margin-left:8px; }
    .label { font-weight:600; margin-right:6px; color:#222; }
    .small { font-size:0.85em; color:#666; }
    .row { display:flex; gap:8px; align-items:center; }
    #rawJson { 
      white-space: pre-wrap; 
      background:#0f1724; 
      color:#dbeafe; 
      padding:8px; 
      border-radius:4px; 
      margin-top:8px; 
      overflow:auto; 
      max-height:220px; 
    }
    footer { 
      padding:10px 12px; 
      font-size:0.8em; 
      color:#666; 
      text-align:center; 
      border-top:1px solid #eee; 
      background: #fafafa;
    }
    .refresh-indicator {
      font-size: 10px;
      color: #999;
      margin-top: 10px;
      text-align: center;
    }
    .ticker-container {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px;
      border-radius: 12px 12px 0 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .weather-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.3);
      margin-bottom: 10px;
    }
    .weather-info {
      display: flex;
      align-items: center;
      gap: 15px;
      font-size: 14px;
      font-weight: 500;
    }
    .weather-temp {
      font-size: 22px;
      font-weight: bold;
    }
    .weather-location {
      font-size: 12px;
      opacity: 0.9;
    }
    .events-section {
      overflow: hidden;
      position: relative;
    }
    .ticker-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 5px;
      opacity: 0.9;
    }
    .ticker-content {
      display: flex;
      animation: scroll 30s linear infinite;
      white-space: nowrap;
    }
    .ticker-item {
      display: inline-flex;
      align-items: center;
      margin-right: 40px;
      font-size: 13px;
    }
    .ticker-icon {
      margin-right: 6px;
      font-size: 16px;
    }
    @keyframes scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
    .ticker-content:hover {
      animation-play-state: paused;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="chat">
      <!-- Weather & Events Ticker -->
      <div class="ticker-container">
        <!-- Static Weather Section -->
        <div class="weather-section">
          <div class="weather-info">
            <span class="weather-temp" id="weather-temp">72¬∞F</span>
            <span id="weather-condition">üå§Ô∏è Sunny</span>
          </div>
          <div class="weather-location" id="weather-location">üìç New York City, NY</div>
        </div>
        
        <!-- Rolling Events Section -->
        <div class="events-section">
          <div class="ticker-title">üéâ Upcoming Events & Activities</div>
          <div class="ticker-content" id="ticker-content">
            <div class="ticker-item"><span class="ticker-icon">üé≠</span>Broadway Show at 8 PM - Times Square</div>
            <div class="ticker-item"><span class="ticker-icon">üçΩÔ∏è</span>Happy Hour 5-7 PM at Hotel Bar</div>
            <div class="ticker-item"><span class="ticker-icon">üé®</span>MoMA Exhibition: Modern Masters - Open until 9 PM</div>
            <div class="ticker-item"><span class="ticker-icon">üèÉ</span>Morning Yoga - Hotel Gym 7 AM Tomorrow</div>
            <div class="ticker-item"><span class="ticker-icon">‚öΩ</span>Yankees Game Tonight - Yankee Stadium 7:30 PM</div>
            <!-- Duplicate for seamless loop -->
            <div class="ticker-item"><span class="ticker-icon">üé≠</span>Broadway Show at 8 PM - Times Square</div>
            <div class="ticker-item"><span class="ticker-icon">üçΩÔ∏è</span>Happy Hour 5-7 PM at Hotel Bar</div>
            <div class="ticker-item"><span class="ticker-icon">üé®</span>MoMA Exhibition: Modern Masters - Open until 9 PM</div>
            <div class="ticker-item"><span class="ticker-icon">üèÉ</span>Morning Yoga - Hotel Gym 7 AM Tomorrow</div>
            <div class="ticker-item"><span class="ticker-icon">‚öΩ</span>Yankees Game Tonight - Yankee Stadium 7:30 PM</div>
          </div>
        </div>
      </div>

      <div id="history"></div>

      <div id="controls">
        <input id="message" placeholder="Ask me anything..." />
        <label class="small"><input type="checkbox" id="shareLocation" /> üìç Location</label>
        <button id="send">Send</button>
        <label id="diagToggle" class="small"><input type="checkbox" id="showDiag" /> üîß</label>
      </div>

      <div id="diagnostics" style="display:none;">
        <div class="row"><span class="label">Client-parsed city:</span><span id="clientCity" class="small">-</span></div>
        <div class="row"><span class="label">Payload coords:</span><span id="payloadCoords" class="small">-</span></div>
        <div class="row"><span class="label">Server intent:</span><span id="srvIntent" class="small">-</span></div>
        <div class="row"><span class="label">Server liveLookup:</span><span id="srvLive" class="small">-</span></div>
        <div class="row"><span class="label">Server reply:</span><span id="srvReply" class="small">-</span></div>
        <div id="rawJson" style="display:none"></div>
      </div>

      <footer>AI Concierge - Real-time Analytics Enabled</footer>
    </div>

    <div id="analytics-panel">
      <div class="analytics-header" onclick="toggleAnalytics()">
        <h3>üìä Guest Services</h3>
        <button class="toggle-btn" id="toggle-icon">‚óÄ</button>
      </div>
      <div class="analytics-content">
        <div class="mini-list">
          <div class="mini-list-title">üè® Hotel Hours & Info</div>
          <div id="hotel-schedule">
            <div class="schedule-item">
              <span class="schedule-label">üç≥ Breakfast</span>
              <span class="schedule-time">6:30 AM - 10:30 AM</span>
            </div>
            <div class="schedule-item">
              <span class="schedule-label">üçΩÔ∏è Restaurant</span>
              <span class="schedule-time">11:00 AM - 11:00 PM</span>
            </div>
            <div class="schedule-item">
              <span class="schedule-label">üèä Pool</span>
              <span class="schedule-time">7:00 AM - 10:00 PM</span>
            </div>
            <div class="schedule-item">
              <span class="schedule-label">üí™ Gym</span>
              <span class="schedule-time">24 Hours</span>
            </div>
            <div class="schedule-item">
              <span class="schedule-label">üõéÔ∏è Front Desk</span>
              <span class="schedule-time">24/7</span>
            </div>
            <div class="schedule-item">
              <span class="schedule-label">üö™ Checkout</span>
              <span class="schedule-time">11:00 AM</span>
            </div>
            <div class="schedule-item">
              <span class="schedule-label">üì∂ WiFi</span>
              <span class="schedule-time">Free - HotelGuest2025</span>
            </div>
          </div>
        </div>

        <div class="quick-actions">
          <button class="action-btn" onclick="quickAction('Housekeeping', 'üßπ')">
            <span class="action-icon">üßπ</span>
            <span class="action-text">Housekeeping</span>
          </button>
          <button class="action-btn" onclick="quickAction('Room Service', 'üçΩÔ∏è')">
            <span class="action-icon">üçΩÔ∏è</span>
            <span class="action-text">Room Service</span>
          </button>
          <button class="action-btn" onclick="quickAction('Restaurant Reservation', 'üç∑')">
            <span class="action-icon">üç∑</span>
            <span class="action-text">Restaurant</span>
          </button>
          <button class="action-btn" onclick="quickAction('Transportation', 'üöï')">
            <span class="action-icon">üöï</span>
            <span class="action-text">Taxi</span>
          </button>
          <button class="action-btn" onclick="quickAction('Maintenance', 'üîß')">
            <span class="action-icon">üîß</span>
            <span class="action-text">Maintenance</span>
          </button>
          <button class="action-btn" onclick="quickAction('Concierge', 'üõéÔ∏è')">
            <span class="action-icon">üõéÔ∏è</span>
            <span class="action-text">Concierge</span>
          </button>
        </div>

        <div class="mini-list">
          <div class="mini-list-title">üéØ Your Open Requests</div>
          <div id="recent-tickets-mini">
            <div style="text-align:center; color:#999; padding:10px;">No tickets</div>
          </div>
        </div>

        <div class="refresh-indicator">
          Updates every 5s ‚Ä¢ <span id="last-refresh">-</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    const historyEl = document.getElementById('history');
    const inputEl = document.getElementById('message');
    const sendBtn = document.getElementById('send');
    const shareCheckbox = document.getElementById('shareLocation');
    const showDiag = document.getElementById('showDiag');
    const diagPanel = document.getElementById('diagnostics');
    const clientCityEl = document.getElementById('clientCity');
    const payloadCoordsEl = document.getElementById('payloadCoords');
    const srvIntentEl = document.getElementById('srvIntent');
    const srvLiveEl = document.getElementById('srvLive');
    const srvReplyEl = document.getElementById('srvReply');
    const rawJsonEl = document.getElementById('rawJson');

    let cachedCoords = null;
    let cachedLocation = null;
    const sessionId = 'session-' + Math.random().toString(36).slice(2,9);
    const conversationHistory = [];

    function append(text, who='bot') {
      const d = document.createElement('div');
      d.className = 'msg ' + (who === 'user' ? 'user' : 'bot');
      d.innerText = (who === 'user' ? 'You: ' : 'Bot: ') + text;
      historyEl.appendChild(d);
      historyEl.scrollTop = historyEl.scrollHeight;
      return d;
    }

    function appendSuggestion(s) {
      const el = document.createElement('div');
      el.className = 'suggestion';
      el.innerHTML = `<strong>${escapeHtml(s.name)}</strong> <span class="small">(${escapeHtml(s.type)})</span>`;
      if (s.reason) {
        const r = document.createElement('div');
        r.className = 'meta';
        r.innerText = `Reason: ${s.reason}`;
        el.appendChild(r);
      }
      historyEl.appendChild(el);
      historyEl.scrollTop = historyEl.scrollHeight;
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (m) => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }

    function parseCityFromText(text) {
      const m = text.match(/near\s+([a-zA-Z\s,]+)/i);
      if (!m) return null;
      const candidate = m[1].trim();
      const token = candidate.toLowerCase();
      if (token === 'me' || token === 'here' || token === 'my hotel' || token === 'myhotel') return null;
      return candidate;
    }

    async function getBrowserLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject(new Error('Geolocation not supported'));
        navigator.geolocation.getCurrentPosition(pos => {
          resolve({ lat: pos.coords.latitude.toString(), lon: pos.coords.longitude.toString() });
        }, err => reject(err), { maximumAge: 60000, timeout: 10000 });
      });
    }

    showDiag.addEventListener('change', () => {
      diagPanel.style.display = showDiag.checked ? 'block' : 'none';
      rawJsonEl.style.display = showDiag.checked ? 'block' : 'none';
    });

    async function sendMessage(text) {
      append(text, 'user');
      const botPlaceholder = append('...', 'bot');

      const clientCity = parseCityFromText(text);
      clientCityEl.innerText = clientCity || '""';

      let consentLocation = false;
      let coords = null;
      payloadCoordsEl.innerText = '""';
      if (shareCheckbox.checked) {
        consentLocation = true;
        try {
          if (!cachedCoords) cachedCoords = await getBrowserLocation();
          coords = cachedCoords;
          payloadCoordsEl.innerText = `${coords.lat}, ${coords.lon}`;
        } catch (err) {
          shareCheckbox.checked = false;
          consentLocation = false;
          payloadCoordsEl.innerText = 'permission denied / unavailable';
          botPlaceholder.innerText = 'Bot: Could not get browser location (permission denied or timeout). Sending without location.';
        }
      }

      const payload = { sessionId, message: text, consentLocation, coords, conversationHistory };

      try {
        const r = await fetch('http://localhost:3000/api/message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const json = await r.json();

        srvIntentEl.innerText = json.intent || '""';
        srvLiveEl.innerText = json.liveLookup === undefined ? '""' : String(json.liveLookup);
        srvReplyEl.innerText = json.reply || '""';
        rawJsonEl.innerText = JSON.stringify(json, null, 2);

        botPlaceholder.innerText = 'Bot: ' + (json.reply || 'Sorry, something went wrong.');
        
        // Track conversation history
        conversationHistory.push({ role: 'user', content: text });
        conversationHistory.push({ role: 'assistant', content: json.reply });
        if (conversationHistory.length > 10) conversationHistory.splice(0, 2);

        if (json.suggestions && json.suggestions.length) {
          const label = document.createElement('div');
          label.className = 'meta';
          label.innerText = json.liveLookup ? 'Live suggestions:' : 'Hotel suggestions (live unavailable):';
          historyEl.appendChild(label);
          json.suggestions.forEach(s => appendSuggestion(s));
        }

        // Refresh analytics after message
        fetchAnalytics();
      } catch (err) {
        botPlaceholder.innerText = 'Bot: Error contacting server';
        rawJsonEl.innerText = String(err && err.message ? err.message : err);
      }
    }

    sendBtn.onclick = () => {
      const t = inputEl.value.trim();
      if (!t) return;
      sendMessage(t);
      inputEl.value = '';
    };

    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendBtn.click();
    });

    // Analytics functions
    function toggleAnalytics() {
      const panel = document.getElementById('analytics-panel');
      const icon = document.getElementById('toggle-icon');
      panel.classList.toggle('collapsed');
      icon.textContent = panel.classList.contains('collapsed') ? '‚ñ∂' : '‚óÄ';
    }

    async function quickAction(requestType, icon) {
      const roomNumber = prompt(`${icon} ${requestType}\n\nPlease enter your room number:`, '209');
      if (!roomNumber) return;

      const details = prompt('Any specific details or requests?', '');
      
      try {
        const response = await fetch('http://localhost:3000/api/message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionId,
            message: `Create a ticket for ${requestType}. Room ${roomNumber}. Details: ${details || 'No specific details'}`,
            consentLocation: false,
            coords: null,
            conversationHistory
          })
        });
        
        const result = await response.json();
        
        // Show confirmation in chat
        append(`Request submitted: ${requestType} for Room ${roomNumber}`, 'user');
        append(result.reply || 'Your request has been submitted. Our team will assist you shortly.', 'bot');
        
        // Refresh analytics to show new ticket
        fetchAnalytics();
      } catch (error) {
        append(`Failed to submit request. Please try again or contact front desk.`, 'bot');
      }
    }

    async function fetchAnalytics() {
      try {
        const response = await fetch('http://localhost:3000/api/analytics');
        const data = await response.json();
        updateAnalytics(data);
      } catch (error) {
        console.error('Failed to fetch analytics:', error);
      }
    }

    function updateAnalytics(data) {
      // Recent tickets only
      const tickets = data.tickets || [];
      const recentTickets = tickets.slice(-5).reverse();
      const ticketsHtml = recentTickets.length > 0
        ? recentTickets.map(t => `
            <div class="mini-list-item">
              <span>${t.requestType}</span>
              <span class="mini-count">${t.ticketId.split('-')[1].slice(0, 6)}</span>
            </div>
          `).join('')
        : '<div style="text-align:center; color:#999; padding:10px;">No open requests</div>';
      document.getElementById('recent-tickets-mini').innerHTML = ticketsHtml;

      // Update refresh time
      document.getElementById('last-refresh').textContent = new Date().toLocaleTimeString();
    }

    // Initial greeting
    append('Hello! Welcome to AI Concierge. How can I help you today?');

    // Fetch analytics on load and every 5 seconds
    fetchAnalytics();
    setInterval(fetchAnalytics, 5000);

    // Update weather and events ticker
    async function updateTicker() {
      try {
        // Get current time for dynamic events
        const now = new Date();
        const hour = now.getHours();
        const dayOfWeek = now.toLocaleDateString('en-US', { weekday: 'long' });
        
        // Try to get user's location
        let userLocation = cachedLocation || 'New York City, NY';
        let coords = cachedCoords;
        
        // Attempt to get browser location if not cached
        if (!cachedCoords) {
          try {
            const position = await new Promise((resolve, reject) => {
              navigator.geolocation.getCurrentPosition(resolve, reject, { 
                timeout: 5000, 
                maximumAge: 300000 
              });
            });
            cachedCoords = {
              lat: position.coords.latitude.toString(),
              lon: position.coords.longitude.toString()
            };
            coords = cachedCoords;
            
            // Reverse geocode to get city name
            const geoResponse = await fetch(
              `https://nominatim.openstreetmap.org/reverse?lat=${coords.lat}&lon=${coords.lon}&format=json`
            );
            const geoData = await geoResponse.json();
            
            if (geoData.address) {
              const city = geoData.address.city || geoData.address.town || geoData.address.village || geoData.address.county;
              const state = geoData.address.state;
              const country = geoData.address.country;
              cachedLocation = city && state ? `${city}, ${state}` : (city || country || 'Your Location');
              userLocation = cachedLocation;
            }
          } catch (error) {
            console.log('Location not available, using default NYC');
          }
        } else {
          userLocation = cachedLocation;
        }
        
        // Fetch real weather data using Open-Meteo API (free, no key needed)
        let weatherData = { temp: 72, condition: 'üå§Ô∏è Sunny', icon: '‚òÄÔ∏è' };
        if (coords) {
          try {
            const weatherResponse = await fetch(
              `https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current_weather=true&temperature_unit=fahrenheit`
            );
            const weather = await weatherResponse.json();
            
            if (weather.current_weather) {
              const temp = Math.round(weather.current_weather.temperature);
              const weatherCode = weather.current_weather.weathercode;
              
              // Map weather codes to conditions
              const weatherConditions = {
                0: { condition: '‚òÄÔ∏è Clear', icon: '‚òÄÔ∏è' },
                1: { condition: 'üå§Ô∏è Mostly Clear', icon: 'üå§Ô∏è' },
                2: { condition: '‚õÖ Partly Cloudy', icon: '‚õÖ' },
                3: { condition: '‚òÅÔ∏è Cloudy', icon: '‚òÅÔ∏è' },
                45: { condition: 'üå´Ô∏è Foggy', icon: 'üå´Ô∏è' },
                48: { condition: 'üå´Ô∏è Foggy', icon: 'üå´Ô∏è' },
                51: { condition: 'üå¶Ô∏è Light Rain', icon: 'üå¶Ô∏è' },
                61: { condition: 'üåßÔ∏è Rain', icon: 'üåßÔ∏è' },
                71: { condition: 'üå®Ô∏è Snow', icon: 'üå®Ô∏è' },
                95: { condition: '‚õàÔ∏è Thunderstorm', icon: '‚õàÔ∏è' }
              };
              
              const weatherInfo = weatherConditions[weatherCode] || { condition: 'üå§Ô∏è Partly Cloudy', icon: '‚õÖ' };
              weatherData = { temp, condition: weatherInfo.condition, icon: weatherInfo.icon };
            }
          } catch (error) {
            console.log('Weather API failed, using default');
          }
        }
        
        // Update static weather display with real data
        document.getElementById('weather-temp').textContent = `${weatherData.temp}¬∞F`;
        document.getElementById('weather-condition').textContent = weatherData.condition;
        document.getElementById('weather-location').textContent = `üìç ${userLocation}`;
        
        // Generate location-specific events
        const isNYC = userLocation.includes('New York');
        const events = [];
        
        if (isNYC) {
          // NYC-specific events
          events.push(
            { icon: 'üé≠', text: 'Broadway Show: Hamilton - Richard Rodgers Theatre 8 PM' },
            { icon: 'üóΩ', text: 'Statue of Liberty Tours - Departing every hour from Battery Park' },
            { icon: 'üé®', text: 'MoMA Exhibition: Modern Masters - Open until 9 PM' },
            { icon: '‚öΩ', text: 'Yankees Game Tonight - Yankee Stadium 7:30 PM' },
            { icon: 'üéµ', text: `${dayOfWeek} Live Jazz - Blue Note Jazz Club 9 PM` },
            { icon: 'üçï', text: "Best Pizza Tour - Little Italy & Brooklyn" }
          );
        } else {
          // Generic hotel events for any location
          events.push(
            { icon: 'üé≠', text: `Check Local Theater Performances Tonight` },
            { icon: 'üé®', text: 'Visit Local Museums & Art Galleries' },
            { icon: 'üçΩÔ∏è', text: 'Explore Downtown Restaurants & Cafes' },
            { icon: 'üèõÔ∏è', text: 'Historical Sites & City Tours Available' },
            { icon: 'üéµ', text: `${dayOfWeek} Live Music - Ask Concierge for Recommendations` },
            { icon: 'üö∂', text: 'Walking Tours & Local Attractions' }
          );
        }
        
        // Add time-based hotel events (works anywhere)
        events.push(
          { icon: 'üçΩÔ∏è', text: hour < 19 ? 'Happy Hour 5-7 PM - Hotel Rooftop Bar' : 'Late Night Menu - Hotel Restaurant until 2 AM' },
          { icon: 'üèÉ', text: hour < 7 ? 'Morning Yoga Class - Hotel Gym 7 AM' : 'Evening Fitness Class - Hotel Gym 6 PM' },
          { icon: 'üõéÔ∏è', text: 'Concierge Services Available 24/7' },
          { icon: 'üöï', text: 'Express Taxi Service - Ask Front Desk' }
        );
        
        // Build rolling events HTML (duplicate for seamless loop)
        const eventsHTML = [...events, ...events].map(e => 
          `<div class="ticker-item"><span class="ticker-icon">${e.icon}</span>${e.text}</div>`
        ).join('');
        
        document.getElementById('ticker-content').innerHTML = eventsHTML;
      } catch (error) {
        console.error('Failed to update ticker:', error);
      }
    }

    // Update ticker on load and every 60 seconds
    updateTicker();
    setInterval(updateTicker, 60000);
  </script>
</body>
</html>
