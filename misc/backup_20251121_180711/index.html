<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>AI Concierge Chat with Analytics</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; 
      padding: 0; 
      display:flex; 
      height:100vh; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .container {
      display: flex;
      width: 100%;
      max-width: 1600px;
      margin: 20px auto;
      gap: 15px;
      padding: 0 15px;
    }
    #chat { 
      flex: 1;
      min-width: 500px;
      max-width: 700px;
      border:1px solid #ddd; 
      display:flex; 
      flex-direction:column; 
      background:#fff; 
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
      border-radius: 12px;
      overflow: hidden;
    }
    #analytics-panel {
      width: 420px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    #analytics-panel.collapsed {
      width: 50px;
    }
    .analytics-header {
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }
    .analytics-header h3 {
      margin: 0;
      font-size: 16px;
      white-space: nowrap;
    }
    #analytics-panel.collapsed .analytics-header h3 {
      writing-mode: vertical-rl;
      transform: rotate(180deg);
    }
    .toggle-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .analytics-content {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }
    #analytics-panel.collapsed .analytics-content {
      display: none;
    }
    .stat-mini {
      background: #f8f9fa;
      border-left: 3px solid #667eea;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }
    .stat-mini-label {
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .stat-mini-value {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }
    .mini-list {
      margin-top: 15px;
    }
    .mini-list-title {
      font-size: 13px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      padding-bottom: 5px;
      border-bottom: 2px solid #f0f0f0;
    }
    .mini-list-item {
      font-size: 12px;
      padding: 6px 0;
      border-bottom: 1px solid #f5f5f5;
      display: flex;
      justify-content: space-between;
    }
    .mini-list-item:last-child {
      border-bottom: none;
    }
    .mini-count {
      color: #667eea;
      font-weight: 600;
    }
    #history { 
      flex:1; 
      padding:12px; 
      overflow:auto; 
      background:#fafafa; 
    }
    .msg { margin:8px 0; }
    .user { text-align:right; color:#003366; font-weight: 500; }
    .bot { text-align:left; color:#004400; }
    #controls { 
      display:flex; 
      padding:12px; 
      border-top:1px solid #eee; 
      align-items:center; 
      gap:8px; 
      background: white;
    }
    input[type=text]{ 
      flex:1; 
      padding:10px; 
      border:1px solid #ccc; 
      border-radius:6px; 
      font-size: 14px;
    }
    input[type=text]:focus {
      outline: none;
      border-color: #667eea;
    }
    button{ 
      padding:10px 16px; 
      border-radius:6px; 
      border:none; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      cursor:pointer; 
      font-weight: 600;
      transition: transform 0.2s;
    }
    button:hover{ 
      transform: scale(1.05);
    }
    .suggestion{ 
      background:#fff; 
      border:1px solid #ddd; 
      padding:8px; 
      margin-top:6px; 
      border-radius:4px; 
    }
    .meta { font-size: 0.85em; color: #666; margin-top:4px; }
    #diagnostics { 
      border-top:1px dashed #eee; 
      padding:10px; 
      font-size:0.9em; 
      color:#333; 
      background:#fcfcfd; 
    }
    #diagToggle { margin-left:8px; }
    .label { font-weight:600; margin-right:6px; color:#222; }
    .small { font-size:0.85em; color:#666; }
    .row { display:flex; gap:8px; align-items:center; }
    #rawJson { 
      white-space: pre-wrap; 
      background:#0f1724; 
      color:#dbeafe; 
      padding:8px; 
      border-radius:4px; 
      margin-top:8px; 
      overflow:auto; 
      max-height:220px; 
    }
    footer { 
      padding:10px 12px; 
      font-size:0.8em; 
      color:#666; 
      text-align:center; 
      border-top:1px solid #eee; 
      background: #fafafa;
    }
    .refresh-indicator {
      font-size: 10px;
      color: #999;
      margin-top: 10px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="chat">
      <div id="history"></div>

      <div id="controls">
        <input id="message" placeholder="Ask me anything..." />
        <label class="small"><input type="checkbox" id="shareLocation" /> üìç Location</label>
        <button id="send">Send</button>
        <label id="diagToggle" class="small"><input type="checkbox" id="showDiag" /> üîß</label>
      </div>

      <div id="diagnostics" style="display:none;">
        <div class="row"><span class="label">Client-parsed city:</span><span id="clientCity" class="small">-</span></div>
        <div class="row"><span class="label">Payload coords:</span><span id="payloadCoords" class="small">-</span></div>
        <div class="row"><span class="label">Server intent:</span><span id="srvIntent" class="small">-</span></div>
        <div class="row"><span class="label">Server liveLookup:</span><span id="srvLive" class="small">-</span></div>
        <div class="row"><span class="label">Server reply:</span><span id="srvReply" class="small">-</span></div>
        <div id="rawJson" style="display:none"></div>
      </div>

      <footer>AI Concierge - Real-time Analytics Enabled</footer>
    </div>

    <div id="analytics-panel">
      <div class="analytics-header" onclick="toggleAnalytics()">
        <h3>üìä Analytics</h3>
        <button class="toggle-btn" id="toggle-icon">‚óÄ</button>
      </div>
      <div class="analytics-content">
        <div class="stat-mini">
          <div class="stat-mini-label">Messages</div>
          <div class="stat-mini-value" id="stat-messages">0</div>
        </div>
        <div class="stat-mini">
          <div class="stat-mini-label">Sessions</div>
          <div class="stat-mini-value" id="stat-sessions">0</div>
        </div>
        <div class="stat-mini">
          <div class="stat-mini-label">Tickets</div>
          <div class="stat-mini-value" id="stat-tickets">0</div>
        </div>

        <div class="mini-list">
          <div class="mini-list-title">üî• Top Questions</div>
          <div id="top-questions-mini">
            <div style="text-align:center; color:#999; padding:10px;">No data yet</div>
          </div>
        </div>

        <div class="mini-list">
          <div class="mini-list-title">üéØ Recent Tickets</div>
          <div id="recent-tickets-mini">
            <div style="text-align:center; color:#999; padding:10px;">No tickets</div>
          </div>
        </div>

        <div class="mini-list">
          <div class="mini-list-title">üìç Locations</div>
          <div id="locations-mini">
            <div style="text-align:center; color:#999; padding:10px;">No searches</div>
          </div>
        </div>

        <div class="refresh-indicator">
          Updates every 5s ‚Ä¢ <span id="last-refresh">-</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    const historyEl = document.getElementById('history');
    const inputEl = document.getElementById('message');
    const sendBtn = document.getElementById('send');
    const shareCheckbox = document.getElementById('shareLocation');
    const showDiag = document.getElementById('showDiag');
    const diagPanel = document.getElementById('diagnostics');
    const clientCityEl = document.getElementById('clientCity');
    const payloadCoordsEl = document.getElementById('payloadCoords');
    const srvIntentEl = document.getElementById('srvIntent');
    const srvLiveEl = document.getElementById('srvLive');
    const srvReplyEl = document.getElementById('srvReply');
    const rawJsonEl = document.getElementById('rawJson');

    let cachedCoords = null;
    const sessionId = 'session-' + Math.random().toString(36).slice(2,9);
    const conversationHistory = [];

    function append(text, who='bot') {
      const d = document.createElement('div');
      d.className = 'msg ' + (who === 'user' ? 'user' : 'bot');
      d.innerText = (who === 'user' ? 'You: ' : 'Bot: ') + text;
      historyEl.appendChild(d);
      historyEl.scrollTop = historyEl.scrollHeight;
      return d;
    }

    function appendSuggestion(s) {
      const el = document.createElement('div');
      el.className = 'suggestion';
      el.innerHTML = `<strong>${escapeHtml(s.name)}</strong> <span class="small">(${escapeHtml(s.type)})</span>`;
      if (s.reason) {
        const r = document.createElement('div');
        r.className = 'meta';
        r.innerText = `Reason: ${s.reason}`;
        el.appendChild(r);
      }
      historyEl.appendChild(el);
      historyEl.scrollTop = historyEl.scrollHeight;
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (m) => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }

    function parseCityFromText(text) {
      const m = text.match(/near\s+([a-zA-Z\s,]+)/i);
      if (!m) return null;
      const candidate = m[1].trim();
      const token = candidate.toLowerCase();
      if (token === 'me' || token === 'here' || token === 'my hotel' || token === 'myhotel') return null;
      return candidate;
    }

    async function getBrowserLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject(new Error('Geolocation not supported'));
        navigator.geolocation.getCurrentPosition(pos => {
          resolve({ lat: pos.coords.latitude.toString(), lon: pos.coords.longitude.toString() });
        }, err => reject(err), { maximumAge: 60000, timeout: 10000 });
      });
    }

    showDiag.addEventListener('change', () => {
      diagPanel.style.display = showDiag.checked ? 'block' : 'none';
      rawJsonEl.style.display = showDiag.checked ? 'block' : 'none';
    });

    async function sendMessage(text) {
      append(text, 'user');
      const botPlaceholder = append('...', 'bot');

      const clientCity = parseCityFromText(text);
      clientCityEl.innerText = clientCity || '""';

      let consentLocation = false;
      let coords = null;
      payloadCoordsEl.innerText = '""';
      if (shareCheckbox.checked) {
        consentLocation = true;
        try {
          if (!cachedCoords) cachedCoords = await getBrowserLocation();
          coords = cachedCoords;
          payloadCoordsEl.innerText = `${coords.lat}, ${coords.lon}`;
        } catch (err) {
          shareCheckbox.checked = false;
          consentLocation = false;
          payloadCoordsEl.innerText = 'permission denied / unavailable';
          botPlaceholder.innerText = 'Bot: Could not get browser location (permission denied or timeout). Sending without location.';
        }
      }

      const payload = { sessionId, message: text, consentLocation, coords, conversationHistory };

      try {
        const r = await fetch('http://localhost:3000/api/message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const json = await r.json();

        srvIntentEl.innerText = json.intent || '""';
        srvLiveEl.innerText = json.liveLookup === undefined ? '""' : String(json.liveLookup);
        srvReplyEl.innerText = json.reply || '""';
        rawJsonEl.innerText = JSON.stringify(json, null, 2);

        botPlaceholder.innerText = 'Bot: ' + (json.reply || 'Sorry, something went wrong.');
        
        // Track conversation history
        conversationHistory.push({ role: 'user', content: text });
        conversationHistory.push({ role: 'assistant', content: json.reply });
        if (conversationHistory.length > 10) conversationHistory.splice(0, 2);

        if (json.suggestions && json.suggestions.length) {
          const label = document.createElement('div');
          label.className = 'meta';
          label.innerText = json.liveLookup ? 'Live suggestions:' : 'Hotel suggestions (live unavailable):';
          historyEl.appendChild(label);
          json.suggestions.forEach(s => appendSuggestion(s));
        }

        // Refresh analytics after message
        fetchAnalytics();
      } catch (err) {
        botPlaceholder.innerText = 'Bot: Error contacting server';
        rawJsonEl.innerText = String(err && err.message ? err.message : err);
      }
    }

    sendBtn.onclick = () => {
      const t = inputEl.value.trim();
      if (!t) return;
      sendMessage(t);
      inputEl.value = '';
    };

    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendBtn.click();
    });

    // Analytics functions
    function toggleAnalytics() {
      const panel = document.getElementById('analytics-panel');
      const icon = document.getElementById('toggle-icon');
      panel.classList.toggle('collapsed');
      icon.textContent = panel.classList.contains('collapsed') ? '‚ñ∂' : '‚óÄ';
    }

    async function fetchAnalytics() {
      try {
        const response = await fetch('http://localhost:3000/api/analytics');
        const data = await response.json();
        updateAnalytics(data);
      } catch (error) {
        console.error('Failed to fetch analytics:', error);
      }
    }

    function updateAnalytics(data) {
      // Update stats
      const sessionCount = Object.keys(data.sessions || {}).length;
      const messageCount = Object.values(data.sessions || {}).reduce((sum, s) => sum + (s.messageCount || 0), 0);
      const ticketCount = (data.tickets || []).length;

      document.getElementById('stat-messages').textContent = messageCount;
      document.getElementById('stat-sessions').textContent = sessionCount;
      document.getElementById('stat-tickets').textContent = ticketCount;

      // Top questions
      const questions = data.questions || {};
      const topQuestions = Object.entries(questions).sort((a, b) => b[1] - a[1]).slice(0, 5);
      const questionsHtml = topQuestions.length > 0
        ? topQuestions.map(([q, count]) => `
            <div class="mini-list-item">
              <span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(q)}</span>
              <span class="mini-count">${count}</span>
            </div>
          `).join('')
        : '<div style="text-align:center; color:#999; padding:10px;">No questions yet</div>';
      document.getElementById('top-questions-mini').innerHTML = questionsHtml;

      // Recent tickets
      const tickets = data.tickets || [];
      const recentTickets = tickets.slice(-5).reverse();
      const ticketsHtml = recentTickets.length > 0
        ? recentTickets.map(t => `
            <div class="mini-list-item">
              <span>${t.requestType}</span>
              <span class="mini-count">${t.ticketId.split('-')[1].slice(0, 6)}</span>
            </div>
          `).join('')
        : '<div style="text-align:center; color:#999; padding:10px;">No tickets</div>';
      document.getElementById('recent-tickets-mini').innerHTML = ticketsHtml;

      // Locations
      const locations = data.locationSearches || {};
      const topLocations = Object.entries(locations).sort((a, b) => b[1] - a[1]).slice(0, 5);
      const locationsHtml = topLocations.length > 0
        ? topLocations.map(([loc, count]) => `
            <div class="mini-list-item">
              <span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(loc)}</span>
              <span class="mini-count">${count}</span>
            </div>
          `).join('')
        : '<div style="text-align:center; color:#999; padding:10px;">No searches</div>';
      document.getElementById('locations-mini').innerHTML = locationsHtml;

      // Update refresh time
      document.getElementById('last-refresh').textContent = new Date().toLocaleTimeString();
    }

    // Initial greeting
    append('Hello! Welcome to AI Concierge. How can I help you today?');

    // Fetch analytics on load and every 5 seconds
    fetchAnalytics();
    setInterval(fetchAnalytics, 5000);
  </script>
</body>
</html>
