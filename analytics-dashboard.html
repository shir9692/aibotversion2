<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel AI Concierge - Analytics Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-card h3 {
            color: #999;
            font-size: 14px;
            text-transform: uppercase;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .metric-value {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .metric-label {
            color: #666;
            font-size: 14px;
        }

        .metric-trend {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }

        .trend-up {
            background: #d4edda;
            color: #155724;
        }

        .trend-down {
            background: #f8d7da;
            color: #721c24;
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .chart-container h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 22px;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            height: 200px;
            gap: 15px;
            margin-top: 20px;
        }

        .bar {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px 8px 0 0;
            position: relative;
            transition: all 0.3s ease;
            min-height: 20px;
        }

        .bar:hover {
            opacity: 0.8;
        }

        .bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #666;
            white-space: nowrap;
        }

        .bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            color: #333;
        }

        .list-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item-title {
            color: #333;
            font-weight: 600;
        }

        .list-item-value {
            color: #667eea;
            font-weight: bold;
        }

        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .refresh-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .refresh-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.6);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>üè® AI Concierge Analytics Dashboard</h1>
            <p>Real-time operational insights and performance metrics</p>
            <button class="refresh-button" onclick="loadAnalytics()" style="margin-top: 20px;">
                üîÑ Refresh Data
            </button>
        </div>

        <!-- Key Performance Metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <h3>Guest Satisfaction</h3>
                <div class="metric-value" id="satisfaction-score">--</div>
                <div class="metric-label">Average Rating (out of 5.0)</div>
                <span class="metric-trend trend-up" id="satisfaction-trend"></span>
            </div>

            <div class="metric-card">
                <h3>AI Deflection Rate</h3>
                <div class="metric-value" id="deflection-rate">--</div>
                <div class="metric-label">Self-Service Success</div>
                <span class="metric-trend trend-up" id="deflection-trend"></span>
            </div>

            <div class="metric-card">
                <h3>RAG Accuracy</h3>
                <div class="metric-value" id="rag-accuracy">--</div>
                <div class="metric-label">Answer Confidence</div>
                <span class="metric-trend trend-up" id="rag-trend"></span>
            </div>

            <div class="metric-card">
                <h3>Avg Response Time</h3>
                <div class="metric-value" id="response-time">--</div>
                <div class="metric-label">Milliseconds</div>
                <span class="metric-trend" id="response-trend"></span>
            </div>

            <div class="metric-card">
                <h3>Cost Savings</h3>
                <div class="metric-value" id="cost-savings">$--</div>
                <div class="metric-label">From AI Deflection</div>
                <span class="metric-trend trend-up" id="savings-trend"></span>
            </div>

            <div class="metric-card">
                <h3>Upsell Conversion</h3>
                <div class="metric-value" id="upsell-rate">--</div>
                <div class="metric-label">Recommendation Success</div>
                <span class="metric-trend" id="upsell-trend"></span>
            </div>
        </div>

        <!-- Peak Demand Times -->
        <div class="chart-container">
            <h2>üìä Peak Demand Hours (Staffing Optimization)</h2>
            <div class="bar-chart" id="peak-demand-chart">
                <div class="empty-state">
                    <p>No demand data yet. Interact with the chatbot to see patterns.</p>
                </div>
            </div>
        </div>

        <!-- Sentiment Analysis Section -->
        <div class="chart-container">
            <h2>üòä Guest Sentiment Analysis</h2>
            <div id="sentiment-bar-chart" class="bar-chart"></div>
            <div id="sentiment-feedback-list"></div>
        </div>

        <!-- Top Service Issues -->
        <div class="list-container">
            <h2>üîß Most Common Service Requests</h2>
            <div id="top-issues-list">
                <div class="empty-state">
                    <p>No service requests yet. Create tickets to see patterns.</p>
                </div>
            </div>
        </div>

        <!-- Operational Insights -->
        <div class="list-container">
            <h2>üí° Knowledge Gaps (What to Add to RAG)</h2>
            <div id="knowledge-gaps-list">
                <div class="empty-state">
                    <p>No knowledge gaps identified yet.</p>
                </div>
            </div>
        </div>

        <!-- Guest Preferences -->
        <div class="list-container">
            <h2>üéØ Guest Preferences (Personalization Insights)</h2>
            <div id="preferences-list">
                <div class="empty-state">
                    <p>No guest preferences collected yet.</p>
                </div>
            </div>
        </div>

        <!-- Service Requests Status -->
        <div class="list-container">
            <h2>üìã Recent Service Requests</h2>
            <div id="service-requests-list">
                <div class="empty-state">
                    <p>No service requests yet.</p>
                </div>
            </div>

            <!-- Open Tickets Section for Staff -->
            <h2 style="margin-top:32px;">üü¢ All Open Tickets</h2>
            <div id="open-tickets-list">
                <div class="empty-state">
                    <p>No open tickets.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function loadAnalytics() {
            try {
                const response = await fetch('/api/analytics');
                const data = await response.json();
                
                // Update KPI Cards
                document.getElementById('satisfaction-score').textContent = 
                    data.guestExperience.satisfactionScore.toFixed(1) || '0.0';
                document.getElementById('deflection-rate').textContent = 
                    data.aiPerformance.deflectionRate.toFixed(0) + '%';
                document.getElementById('rag-accuracy').textContent = 
                    data.aiPerformance.ragAccuracy.toFixed(0) + '%';
                document.getElementById('response-time').textContent = 
                    data.aiPerformance.avgResponseTimeMs.toFixed(0);
                document.getElementById('cost-savings').textContent = 
                    '$' + data.insights.costSavings.estimatedSavings.toFixed(0);
                document.getElementById('upsell-rate').textContent = 
                    data.revenue.upsellConversionRate.toFixed(0) + '%';

                // Update trends
                updateTrend('satisfaction-trend', data.guestExperience.satisfactionScore, 4.0);
                updateTrend('deflection-trend', data.aiPerformance.deflectionRate, 70);
                updateTrend('rag-trend', data.aiPerformance.ragAccuracy, 85);
                updateTrend('response-trend', data.aiPerformance.avgResponseTimeMs, 2000, true);
                updateTrend('savings-trend', data.insights.costSavings.estimatedSavings, 50);
                updateTrend('upsell-trend', data.revenue.upsellConversionRate, 20);

                // Render Peak Demand Chart
                renderPeakDemandChart(data.operations.peakDemandHours);

                // Render Sentiment Analysis
                if (data.guestExperience && data.guestExperience.sentimentByGuest) {
                    renderSentimentBarChart(data.guestExperience.sentimentByGuest);
                    renderSentimentFeedbackList(data.guestExperience.sentimentByGuest);
                } else {
                    document.getElementById('sentiment-bar-chart').innerHTML = '<div class="empty-state"><p>No sentiment data yet.</p></div>';
                    document.getElementById('sentiment-feedback-list').innerHTML = '';
                }

                // Render Top Issues
                renderTopIssues(data.insights.topIssues);

                // Render Knowledge Gaps
                renderKnowledgeGaps(data.aiPerformance.knowledgeGaps);

                // Render Guest Preferences
                renderPreferences(data.insights.guestPreferences);

                                // Render Service Requests
                                renderServiceRequests(data.raw.serviceRequests);

                                // Render Open Tickets for staff
                                if (data.raw.openTickets && Array.isArray(data.raw.openTickets)) {
                                    renderOpenTickets(data.raw.openTickets);
                                }
        // Render open tickets for staff
        function renderOpenTickets(tickets) {
            const container = document.getElementById('open-tickets-list');
            if (!container) return;
            if (!tickets || tickets.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No open tickets.</p></div>';
                return;
            }
            container.innerHTML = tickets.map(ticket => {
                const statusBadge = ticket.status === 'resolved' ? 'badge-success' : 
                                   ticket.status === 'open' ? 'badge-warning' : 'badge-info';
                const priorityBadge = ticket.priority === 'High' || ticket.priority === 'Urgent' ? 
                                     'badge-danger' : 'badge-info';
                return `
                    <div class="list-item">
                        <div>
                            <div class="list-item-title">${ticket.requestType} - ${ticket._id || ticket.ticketId}</div>
                            <div style="color: #666; font-size: 13px; margin-top: 4px;">
                                üë§ ${ticket.guestName || 'Guest'} ‚Ä¢ üö™ Room ${ticket.roomNumber || 'N/A'}
                            </div>
                            <div style="color: #888; font-size: 12px; margin-top: 2px;">
                                ${ticket.description || 'No description'}
                            </div>
                            <span class="badge ${statusBadge}">${ticket.status}</span>
                            <span class="badge ${priorityBadge}">${ticket.priority} priority</span>
                        </div>
                        <div style="text-align: right; color: #999; font-size: 12px;">
                            ${ticket.createdAt ? new Date(ticket.createdAt).toLocaleString() : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

            } catch (error) {
                console.error('Failed to load analytics:', error);
            }
        }

        function updateTrend(elementId, value, threshold, inverse = false) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const isGood = inverse ? (value < threshold) : (value >= threshold);
            element.className = 'metric-trend ' + (isGood ? 'trend-up' : 'trend-down');
            element.textContent = isGood ? '‚úì Target Met' : '‚ö† Needs Attention';
        }

        function renderPeakDemandChart(peakHours) {
            const chartContainer = document.getElementById('peak-demand-chart');
            if (!peakHours || peakHours.length === 0) {
                chartContainer.innerHTML = '<div class="empty-state"><p>No demand data yet.</p></div>';
                return;
            }

            const maxRequests = Math.max(...peakHours.map(h => h.requests));
            chartContainer.innerHTML = peakHours.map(hour => {
                const height = (hour.requests / maxRequests) * 100;
                const timeLabel = formatHour(hour.hour);
                return `
                    <div class="bar" style="height: ${height}%;">
                        <div class="bar-value">${hour.requests}</div>
                        <div class="bar-label">${timeLabel}</div>
                    </div>
                `;
            }).join('');
        }

        function formatHour(hour) {
            const period = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}${period}`;
        }

        // Sentiment Bar Chart Renderer
        function renderSentimentBarChart(sentimentByGuest) {
            const chartContainer = document.getElementById('sentiment-bar-chart');
            if (!sentimentByGuest || Object.keys(sentimentByGuest).length === 0) {
                chartContainer.innerHTML = '<div class="empty-state"><p>No sentiment data yet.</p></div>';
                return;
            }
            // Prepare data
            const guests = Object.keys(sentimentByGuest);
            chartContainer.innerHTML = guests.map(guest => {
                const score = sentimentByGuest[guest].score;
                const barHeight = ((score + 1) / 2) * 100; // Normalize to [0,100]
                let color = score > 0.3 ? '#67eaa2' : score < -0.3 ? '#ea6767' : '#eae767';
                return `
                    <div class="bar" style="height: ${barHeight}%; background: ${color};">
                        <div class="bar-value">${score.toFixed(2)}</div>
                        <div class="bar-label">${guest}</div>
                    </div>
                `;
            }).join('');
        }

        // Sentiment Feedback List Renderer
        function renderSentimentFeedbackList(sentimentByGuest) {
            const feedbackContainer = document.getElementById('sentiment-feedback-list');
            if (!sentimentByGuest || Object.keys(sentimentByGuest).length === 0) {
                feedbackContainer.innerHTML = '';
                return;
            }
            let html = '<h3 style="margin-top:30px; color:#667eea;">Latest Guest Feedback</h3>';
            html += '<ul style="list-style:none; padding:0;">';
            Object.entries(sentimentByGuest).forEach(([guest, obj]) => {
                if (obj.feedback) {
                    html += `<li style="margin-bottom:12px; background:#f7f7fa; padding:12px; border-radius:8px;">
                        <strong>${guest}:</strong> <span style="color:#333;">${obj.feedback}</span>
                        <span style="float:right; color:#888; font-size:12px;">Sentiment: ${obj.score.toFixed(2)}</span>
                    </li>`;
                }
            });
            html += '</ul>';
            feedbackContainer.innerHTML = html;
        }

        function renderTopIssues(issues) {
            const container = document.getElementById('top-issues-list');
            if (!issues || issues.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No service requests yet.</p></div>';
                return;
            }

            container.innerHTML = issues.map(issue => `
                <div class="list-item">
                    <div>
                        <div class="list-item-title">${issue.category}</div>
                        <span class="badge badge-info">${issue.count} requests</span>
                        ${issue.avgResolutionTime > 0 ? 
                            `<span class="badge badge-warning">${(issue.avgResolutionTime / 60000).toFixed(0)} min avg</span>` 
                            : ''}
                    </div>
                    <div class="list-item-value">${issue.count}</div>
                </div>
            `).join('');
        }

        function renderKnowledgeGaps(gaps) {
            const container = document.getElementById('knowledge-gaps-list');
            if (!gaps || gaps.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No knowledge gaps identified. AI is performing well!</p></div>';
                return;
            }

            container.innerHTML = gaps.slice(0, 10).map(gap => `
                <div class="list-item">
                    <div class="list-item-title">‚ùì "${gap.query}"</div>
                    <span class="badge badge-danger">Add to knowledge base</span>
                </div>
            `).join('');
        }

        function renderPreferences(preferences) {
            const container = document.getElementById('preferences-list');
            if (!preferences || Object.keys(preferences).length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No guest preferences collected yet.</p></div>';
                return;
            }

            let html = '';
            for (const [category, values] of Object.entries(preferences)) {
                if (values && values.length > 0) {
                    html += `<div style="margin-bottom: 20px;">
                        <h3 style="color: #667eea; margin-bottom: 10px; text-transform: capitalize;">${category}</h3>`;
                    values.forEach(item => {
                        html += `
                            <div class="list-item">
                                <div class="list-item-title">${item.value}</div>
                                <div class="list-item-value">${item.count} guests</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
            }
            container.innerHTML = html || '<div class="empty-state"><p>No preferences data.</p></div>';
        }

        function renderServiceRequests(requests) {
            const container = document.getElementById('service-requests-list');
            if (!requests || requests.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No service requests yet.</p></div>';
                return;
            }

            const recentRequests = requests.slice(-10).reverse();
            container.innerHTML = recentRequests.map(request => {
                const statusBadge = request.status === 'resolved' ? 'badge-success' : 
                                   request.status === 'open' ? 'badge-warning' : 'badge-info';
                const priorityBadge = request.priority === 'High' || request.priority === 'Urgent' ? 
                                     'badge-danger' : 'badge-info';
                
                return `
                    <div class="list-item">
                        <div>
                            <div class="list-item-title">${request.type} - ${request.ticketId}</div>
                            <div style="color: #666; font-size: 13px; margin-top: 4px;">
                                üë§ ${request.guestName || 'Guest'} ‚Ä¢ üö™ Room ${request.roomNumber || 'N/A'}
                            </div>
                            <div style="color: #888; font-size: 12px; margin-top: 2px;">
                                ${request.description || 'No description'}
                            </div>
                            <span class="badge ${statusBadge}">${request.status}</span>
                            <span class="badge ${priorityBadge}">${request.priority} priority</span>
                        </div>
                        <div style="text-align: right; color: #999; font-size: 12px;">
                            ${new Date(request.createdAt).toLocaleString()}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load analytics on page load
        loadAnalytics();

        // Auto-refresh every 30 seconds
        setInterval(loadAnalytics, 30000);
    </script>
</body>
</html>
